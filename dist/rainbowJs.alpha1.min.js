"use strict";function RainbowDom(e,t,n,o){var r=this,i=!1,a="",u=new RainbowTools,l=function(e,t){var n=e.nodeName.toLowerCase();if("select"===n&&"undefined"!==r.vm[t].selectedIndex){var o=r.vm[t].selectedIndex;"undefined"!=typeof e.childNodes[o]&&(e.childNodes[o].selected="selected")}},f=function(e,t,n){for(var o=0;o<n.length;o+=1){new RainbowVM("with",n[o],r.vmId,t[o]);for(var u=0;u<t[o].length;u+=1)e.appendChild(t[o][u])}i=!1,a=""},s=function(e,t,n,o){var r=u.getClones(t,n.length);u.removeChildrenNode(e),f(e,r,n),l(e,o)},c=function(e,t){for(var n=null,o=0;o<e[t].tokenPositions.length;o+=1)n=e[t].tokenPositions[o],e[t].parts[n]=O(String(e[t].defaultParts[n]));return n},d=function(e,t,n,o){var r=_slicedToArray(o,3),i=r[0],a=r[1],l=r[2];"with"===a?Array.isArray(e[t].parts[n])&&s(e[t].node,e[t].defaultNode,e[t].parts[n],i):u.setProp(e,t,l)},p=function(e,t,n){for(var o=r.observableList[t][e],i=null,a=[e,t,n],u=0;u<o.length;u+=1)i=c(o,u),d(o,u,i,a)},v=function(e){for(var t=0;t<e.infos.length;t+=1){var n=e.infos[t].property;"undefined"!=typeof r.vm[n]&&("undefined"==typeof r.observableList.text[n]&&(r.observableList.text[n]=[]),r.observableList.text[n].push(e),p(n,"text","nodeValue"))}},y=function(e){var t=e.infos[0].property;"undefined"!=typeof r.vm[t]&&("undefined"==typeof r.observableList.input[t]&&(r.observableList.input[t]=[]),r.observableList.input[t].push(e),p(t,"input","value"))},b=function(e){var t=e.infos[0].property;"undefined"!=typeof r.vm[t]&&("undefined"==typeof r.observableList.input[t]&&(r.observableList.input[t]=[]),r.observableList.input[t].push(e),p(t,"input","checked"))},h=function(e){var t=e.infos[0].property;"undefined"!=typeof r.vm[t]&&("undefined"==typeof r.observableList.input[t]&&(r.observableList.input[t]=[]),r.observableList.input[t].push(e),p(t,"input","checked"))},m=function(e,t){var n=t.replace("{{#","").replace("}}",""),o=e.parentNode;o.removeChild(o.lastChild),o.removeChild(o.firstChild);var i=u.getMustacheInfo("{{"+n+"}}",o,"{{"+n+"}}"),a=i.infos[0].property;"undefined"!==r.vm[a]?("undefined"==typeof r.observableList["with"][a]&&(r.observableList["with"][a]=[]),r.observableList["with"][a].push(i),p(a,"with","with")):e.parentNode.style.visibility="hidden"},g=function(e,t){-1!==e.indexOf("{{#")?(i=!0,a=e.replace("#","/"),m(t,e)):i||v(u.getMustacheInfo(e,t,t.nodeValue))},w=function(e){var t=u.getAttributeValue(e.node,"type");"text"===t||"password"===t||"email"===t?y(e):"checkbox"===t?h(e):"radio"===t&&b(e)},x=function(e,t){var n=u.getMatches(e,t,"elementsTobind");null!==n&&"value"===t?w(u.getMustacheInfo(n[0],e,e.value)):null!==n&&"nodeValue"===t&&g(n[0],e)},L=function(e){"#text"===e.nodeName?x(e,"nodeValue"):"INPUT"!==e.nodeName||i||x(e,"value")},N=function E(e){for(var t=0;t<e.length;t+=1)L(e[t]),i||E(e[t].childNodes)},k=function(e,t,n,o,r){t.nodeName===n&&t[o]===r&&N(e.childNodes)},A=function(e,t,n,o){for(var r=0;r<e.attributes.length;r+=1)k(e,e.attributes[r],t,n,o)},C=function(t){for(var n=0;n<t.length;n+=1)"with"===r.name?N(t[n].childNodes):A(t[n],"vm.bind","value",e);P()},I=function(e,t,n){for(var o=r.vm,i=u.getContextValue(n),a=n.nodeName.toLowerCase(),l=e.infos.length,f=0;l>f;f+=1){var s=null,c=e.infos[f],d=c.property,p=c.type,v=_typeof(o[d]);"undefined"!==v&&"function"===v&&v===p?(s=o[d](t,i),null!==s&&(i=s)):"object"===v&&"property"===p&&"select"===a&&f+1>=l?o.selectedIndex=i:"object"===v&&"property"===p?o=o[d]:"undefined"!==v&&"property"===p?o[d]=i:"undefined"!==v&&"array"===p&&(o=o[d]),f+1>=l&&(r.proxy[t]=r.vm[t])}},O=function _(e,t){var n=r.vm,o=e,i=/\w+|\[|\]/gi,a=e.match(i),u=!1;"undefined"==typeof t&&(t=0);for(var l=t;l<a.length;l+=1){var f=a[l];if("["!==a[l]||u)if("]"===a[l]){if(u=!1,t>0)break}else u||("undefined"!=typeof n[f]?(o=n[f],n=o):t>0&&(o=f));else u=!0,f=_(e,l+1),o=n[f],n=o}return o},P=function(){for(var e in r.observableList.input)S(e);for(var t in r.observableList["with"])j(t)},S=function(e){for(var t=r.observableList.input[e],n=0;n<t.length;n+=1){var o=t[n].node,i=t[n];T(o,i,e)}},j=function(e){for(var t=r.observableList["with"][e],n=0;n<t.length;n+=1){var o=t[n].node,i=t[n];T(o,i,e)}},T=function(e,t,n){e.addEventListener("change",function(e){e.preventDefault(),I(t,n,this);var o=u.getAttributeValue(this,"type");if("radio"===o)for(var i=0;i<r.observableList.input[n].length;i+=1){var a=r.observableList.input[n][i];I(a,n,a.node)}})},M=function(e,t){if("undefined"!=typeof r.observableList.text[e])p(e,"text","nodeValue");else if("undefined"!=typeof r.observableList.input[e])for(var n=r.observableList.input[e],o=0;o<n.length;o+=1){var i=u.getAttributeValue(n[o].node,"type");"input"===i?p(e,"input","value"):"checkbox"===i?p(e,"input","checked"):"radio"===i&&p(e,"input","checked")}else"undefined"!=typeof r.observableList["with"][e]&&p(e,"with","with")},V=function(){r.proxy=new Proxy(r.vm,R),r.vm.proxy=r.proxy},R={set:function(e,t,n){if("function"!=typeof e[t]){var o=e[t];e[t]=n,u.localPush(r.vmId,e),M(t,o)}return!0}};return r.name=e,r.vm=t,r.vmId=n,r.proxy=null,r.keys=Object.keys(r.vm),r.observableList={input:{},text:{},"with":{}},r.getAllMatchingVM=function(){C("with"===r.name?o:u.getAllElementsWithAttribute("vm.bind"))},V(),r}function RainbowRequest(e,t,n){var o=this,r=new XMLHttpRequest,i=function(){if(!r)throw"Giving up :( Cannot create an XMLHTTP instance)"},a=function(){if("undefined"!=typeof o.currentObject&&"undefined"!=typeof o.currentObject.key&&""!==o.result.trim()){var e=o.currentObject.key;console.log("prop:",e);var t=JSON.parse(o.result);o.proxy[e]=t[e]}else console.log("no keys to process")},u=function(){r.onreadystatechange=l,r.open(o.currentObject.method,o.currentObject.url),f()},l=function(){r.readyState===XMLHttpRequest.DONE&&(o.result=r.responseText,console.log(o.result),a(),s())},f=function(){"undefined"!=typeof data?r.send(encodeURIComponent(JSON.stringify(data))):r.send()},s=function(){"undefined"!=typeof o.currentObject&&"function"==typeof o.currentObject.callback&&o.currentObject.callback()};return o.api=e,o.id=n,o.proxy=t,o.result=null,o.currentObject=null,o.headers={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},o.ajax=function(e){try{e in o.api&&(o.currentObject=o.api[e],i(),u())}catch(t){o.result=t}},o}function RainbowTools(){var e=this;return e.pattern={elementsTobind:/[\{]{2}[#|\/]*[\w_]+\d*(\[\d*|(.)*\])*(\.[^\.][\w_]*\d*|\(\)(?=\.|[\}]{2}|\[)|(\[\d*|(.)*\])*)*[\}]{2}/gi,mustacheInfo:/\w+|\(\)|\[|\]|\d/gi,replaceParts:/\w+[[^\S]*[^[\}]]*|\(\)|\[|\]|\d|\{\{|\}\}/gi},e.isElementAttributeNull=function(e,t,n){null!==t.getAttribute(n)&&e.push(t)},e.getAllElementsWithAttribute=function(t){return e.loopOnAllElements(document.getElementsByTagName("*"),t)},e.loopOnAllElements=function(t,n){for(var o=[],r=0,i=t.length;i>r;r+=1)e.isElementAttributeNull(o,t[r],n);return o},e.getMustacheInfo=function(t,n,o){var r={node:n,infos:[]},i=e.getReplaceParts(o);return r.defaultNode=e.copyNode(n,1)[0],r.parts=i,r.defaultParts=e.toNewArray(i),r.tokenPositions=e.getTokenPositionsInParts(t,i),r.infos=e.getMustacheTokenType(t.match(e.pattern.mustacheInfo)),r},e.getMustacheTokenType=function(e){for(var t=[],n=0;n<e.length;n+=1){var o=e[n],r=e[n+1];"()"===r?(t.push({type:"function",property:o}),n+=1):"["===r?(t.push({type:"array",property:o}),n+=1):"]"!==o&&t.push({type:"property",property:o})}return t},e.getTokenPositionsInParts=function(e,t){for(var n=[],o=!1,r=0;r<t.length;r+=1)"{{"===t[r]?o=!0:"}}"===t[r]?o=!1:o&&n.push(r);return n},e.getReplaceParts=function(t){return t.match(e.pattern.replaceParts)},e.getContextValue=function(t){var n=null,o=e.getAttributeValue(t,"type").toLowerCase(),r=t.nodeName.toLowerCase();return"text"===o||"password"===o||"email"===o?n=t.value:"checkbox"===o?n=t.checked:"radio"===o?n=t.checked:"select"===r&&(n=t.selectedIndex),n},e.getMatches=function(t,n,o){return t[n].match(e.pattern[o])},e.getAttributeValue=function(e,t){for(var n="",o=0;o<e.attributes.length;o+=1){var r=e.attributes[o];if(r.nodeName===t){n=r.nodeValue;break}}return n},e.getClones=function(t,n,o){for(var r=[],i=0;n>i&&"undefined"!=typeof t.childNodes;i+=1)r.push(t.cloneNode(!0).childNodes);return"undefined"!=typeof o&&e.removeChildrenNode(t),r},e.copyNode=function(t,n,o){for(var r=[],i=0;n>i;i+=1)r.push(t.cloneNode(!0));return"undefined"!=typeof o&&e.removeChildrenNode(t),r},e.removeChildrenNode=function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},e.toNewArray=function(e){for(var t=[],n=0;n<e.length;n+=1)t.push(e[n]);return t},e.localPush=function(t,n){var o=[],r=e.copyObject(n,"proxy"),i=JSON.stringify(r,function(e,t){if("object"===("undefined"==typeof t?"undefined":_typeof(t))){if(o.indexOf(t)>=0)return;o.push(t)}return t});"undefined"!=typeof Storage&&localStorage.setItem(t,i)},e.localPull=function(e,t){var n={};if("undefined"!=typeof Storage){var o=JSON.parse(localStorage.getItem(e));"undefined"==typeof t?n=o:"undefined"!=typeof o[t]&&(n=o[t])}return n},e.getStringWhithoutBrackets=function(e){var t=e.join("");return t=t.replace("{{",""),t=t.replace("}}","")},e.setProp=function(t,n,o){var r=e.getStringWhithoutBrackets(t[n].parts);"checked"===o?"true"===r?t[n].node[o]=!0:t[n].node[o]=!1:t[n].node[o]=r},e.copyObject=function(e,t){var n={};for(var o in e)o!==t&&(n[o]=e[o]);return n},e}function RainbowVM(e,t,n,o,r){var i=this,a=(new RainbowTools,new RainbowDom(e,t,n,o));return i.name=e,i.vm=t,i.vmId=n,i.api=r,i.proxy=a.proxy,i.keys=a.keys,i.observableList=a.observableList,a.getAllMatchingVM(),i.getAPI=function(){if("undefined"!=typeof i.api&&null!==i.api){for(var e=new RainbowRequest(i.api,i.proxy,i.name),t=0;t<i.api.length;t++)e.ajax(t);console.log("ok")}},i.getAPI(),i.vm}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_slicedToArray=function(){function e(e,t){var n=[],o=!0,r=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(o=(a=u.next()).done)&&(n.push(a.value),!t||n.length!==t);o=!0);}catch(l){r=!0,i=l}finally{try{!o&&u["return"]&&u["return"]()}finally{if(r)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};